<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Query Assistant</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 900px; 
            margin: 20px auto; 
            padding: 20px;
            background-color: #f5f5f5;
            line-height: 1.6;
        }

        h1 {
            color: #2196f3;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-top: 0;
            margin-bottom: 20px;
        }

        .examples {
            background-color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .examples h2 {
            margin-top: 0;
            color: #1976d2;
            font-size: 1.2rem;
        }

        .examples ul {
            padding-left: 20px;
            columns: 2;
        }

        .examples li {
            margin: 8px 0;
            color: #555;
            cursor: pointer;
        }

        .examples li:hover {
            color: #2196f3;
            text-decoration: underline;
        }

        #messages { 
            border: 1px solid #ddd; 
            padding: 10px; 
            margin: 10px 0; 
            height: 400px; 
            overflow-y: auto;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .user-message { 
            background-color: #e3f2fd; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 15px 15px 3px 15px;
            max-width: 80%;
            margin-left: auto;
            position: relative;
        }

        .system-message { 
            background-color: #f5f5f5; 
            padding: 12px; 
            margin: 10px 0; 
            border-radius: 15px 15px 15px 3px;
            max-width: 80%;
            white-space: pre-wrap;
            position: relative;
        }

        .message-time {
            font-size: 0.7rem;
            color: #999;
            text-align: right;
            margin-top: 5px;
        }

        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
            border-left: 4px solid #e53935;
        }
        
        .error-message ul {
            margin-top: 5px;
            margin-bottom: 5px;
            padding-left: 25px;
        }
        
        .error-message li {
            margin-bottom: 3px;
        }

        .sql-container {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            overflow-x: auto;
        }

        .sql-title {
            color: #666;
            font-size: 0.8rem;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .data-container {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f2f2f2;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .download-container {
            display: flex;
            justify-content: flex-end;
            padding: 8px;
            background-color: #f9fafb;
            border-bottom: 1px solid #ddd;
        }

        .download-button {
            background-color: #4caf50;
            color: white;
            font-size: 0.75rem;
            padding: 5px 10px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            margin-left: 5px;
        }

        .download-button:hover {
            background-color: #388e3c;
        }

        .input-container {
            display: flex;
            margin-top: 15px;
        }

        #input-box { 
            flex: 1;
            padding: 12px; 
            border-radius: 25px;
            border: 1px solid #ddd;
            outline: none;
            font-size: 1rem;
        }

        #input-box:focus {
            border-color: #2196f3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        #send-button {
            padding: 10px 20px;
            background-color: #2196f3;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-left: 10px;
            font-weight: bold;
        }

        #send-button:hover:not(:disabled) {
            background-color: #1976d2;
        }

        #send-button:disabled {
            background-color: #bdbdbd;
            cursor: not-allowed;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 10px;
            color: #666;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background-color: #2196f3;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }

        .empty-message {
            color: #9e9e9e;
            text-align: center;
            margin-top: 150px;
        }
        
        /* Status indicator for server connectivity */
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-left: 10px;
        }
        
        .status-indicator.connected {
            background-color: #4caf50;
        }
        
        .status-indicator.disconnected {
            background-color: #f44336;
        }
        
        /* Debug panel (hidden by default) */
        #debug-panel {
            position: fixed;
            bottom: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            max-width: 400px;
            max-height: 200px;
            overflow: auto;
            font-size: 12px;
            display: none;
        }
        
        .debug-active #debug-panel {
            display: block;
        }
        
        #debug-toggle {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: #333;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <h1>Database Query Assistant <span class="status-indicator" id="connection-status"></span></h1>
    <p class="subtitle">Ask questions about your database in natural language</p>

    <div class="examples">
        <h2>Example Queries</h2>
        <ul id="example-list">
            <li data-query="Show me all active users">Show me all active users</li>
            <li data-query="When did John Doe last log in?">When did John Doe last log in?</li>
            <li data-query="How many users have we had since October 2023?">How many users have we had since October 2023?</li>
            <li data-query="Which user has the earliest creation date?">Which user has the earliest creation date?</li>
            <li data-query="List all users with gmail.com email addresses">List all users with gmail.com email addresses</li>
            <li data-query="Find inactive users">Find inactive users</li>
        </ul>
    </div>

    <div id="messages">
        <div class="empty-message">Start a conversation by asking a question about your database</div>
    </div>

    <!-- Changed to a form element for better event handling -->
    <form id="chat-form" class="input-container">
        <input type="text" id="input-box" placeholder="Ask about your database...">
        <button type="submit" id="send-button">Send</button>
    </form>
    
    <!-- Debug toggle button -->
    <button id="debug-toggle">Debug</button>
    <div id="debug-panel"></div>
    
    <!-- System diagnostics panel (hidden by default) -->
    <div id="diagnostics-panel" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); max-width: 500px; width: 90%; z-index: 1000;">
        <h3 style="margin-top: 0;">System Diagnostics</h3>
        <div id="diagnostics-content">
            <p>Running system checks...</p>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 15px;">
            <button id="run-diagnostics-btn" style="padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">Run Checks</button>
            <button id="close-diagnostics-btn" style="padding: 8px 16px; background: #e0e0e0; border: none; border-radius: 4px; cursor: pointer;">Close</button>
        </div>
    </div>
    
    <!-- Diagnostics button -->
    <button id="show-diagnostics-btn" style="position: fixed; bottom: 50px; right: 10px; background: #ff9800; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer; z-index: 1000;">Diagnose System</button>

    <script>
        // Debug utilities
        const debugPanel = document.getElementById('debug-panel');
        const debugToggle = document.getElementById('debug-toggle');
        
        function log(message) {
            console.log(message);
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugPanel.appendChild(logEntry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
        }
        
        debugToggle.addEventListener('click', function() {
            document.body.classList.toggle('debug-active');
        });
        
        // Check server connectivity
        async function checkServerConnectivity() {
            const statusIndicator = document.getElementById('connection-status');
            try {
                const response = await fetch('/health', { method: 'GET' });
                if (response.ok) {
                    statusIndicator.classList.add('connected');
                    statusIndicator.classList.remove('disconnected');
                    statusIndicator.title = 'Connected to server';
                    log('Server connection: OK');
                    return true;
                } else {
                    throw new Error('Server returned non-OK status');
                }
            } catch (error) {
                statusIndicator.classList.add('disconnected');
                statusIndicator.classList.remove('connected');
                statusIndicator.title = 'Disconnected from server';
                log(`Server connection failed: ${error.message}`);
                return false;
            }
        }
        
        // Chat state
        const state = {
            messages: [],
            conversationId: null,
            isLoading: false,
            serverConnected: false
        };

        // DOM elements
        const messagesDiv = document.getElementById('messages');
        const inputBox = document.getElementById('input-box');
        const sendButton = document.getElementById('send-button');
        const chatForm = document.getElementById('chat-form');

        // Helper function to generate request ID
        function generateRequestId() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Add example query to input box
        function useExample(example) {
            inputBox.value = example;
            inputBox.focus();
            log(`Example selected: ${example}`);
        }

        // Send message to backend
        async function sendMessage(event) {
            if (event) event.preventDefault();
            log('sendMessage function called');
            
            const message = inputBox.value.trim();
            log(`Message content: "${message}"`);
            
            if (!message || state.isLoading) {
                log(`Early return - message empty: ${!message}, already loading: ${state.isLoading}`);
                return;
            }
            
            // Store original message for potential error recovery
            const originalMessage = message;
            
            // Clear input and focus (do this early)
            inputBox.value = '';
            inputBox.focus();
            
            // Add user message to UI (this should happen BEFORE any async operations)
            const userMessageId = `user-message-${Date.now()}`;
            addMessageToUI('user', message, {}, userMessageId);
            
            // Set loading state
            state.isLoading = true;
            updateSendButtonState();
            
            // Generate a requestId for this message
            const requestId = generateRequestId();
            log(`Request ID generated: ${requestId}`);
            
            // Add loading indicator
            const loadingElement = document.createElement('div');
            loadingElement.className = 'system-message loading';
            loadingElement.id = 'loadingIndicator';
            
            for (let i = 0; i < 3; i++) {
                const dot = document.createElement('div');
                dot.className = 'loading-dot';
                loadingElement.appendChild(dot);
            }
            
            messagesDiv.appendChild(loadingElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            try {
                // Remove empty message if present
                const emptyMessage = document.querySelector('.empty-message');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
                
                // Check server connection 
                let isConnected = false;
                try {
                    isConnected = await checkServerConnectivity();
                    if (!isConnected) {
                        throw new Error('Cannot connect to the server. Please check if the backend is running.');
                    }
                } catch (connectionError) {
                    throw new Error(`Connection error: ${connectionError.message}`);
                }
                
                log(`Sending request to /api/chat with message: ${message.substring(0, 30)}...`);
                
                // Send request to backend with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Request-ID': requestId
                        },
                        body: JSON.stringify({
                            message,
                            conversationId: state.conversationId
                        }),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    log(`Response status: ${response.status}`);
                    
                    if (!response.ok) {
                        // Try to get error details if available
                        let errorMessage = `Server error: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            if (errorData && errorData.message) {
                                errorMessage = errorData.message;
                            }
                        } catch (e) {
                            // If we can't parse the error, use the default message
                        }
                        throw new Error(errorMessage);
                    }
                    
                    const data = await response.json();
                    log(`Response data received, conversation ID: ${data.conversationId}`);
                    
                    // Update conversation ID
                    state.conversationId = data.conversationId;
                    
                    // Add AI message to UI
                    addMessageToUI('system', data.message, {
                        sql: data.sql,
                        data: data.data,
                        filename: data.filename
                    });
                } catch (fetchError) {
                    if (fetchError.name === 'AbortError') {
                        throw new Error('Request timed out after 30 seconds. The server might be busy or experiencing issues.');
                    }
                    throw fetchError;
                } finally {
                    clearTimeout(timeoutId);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                log(`Error: ${error.message}`);
                
                // Add error message BELOW the user's message (which is preserved)
                // Create a more helpful error message
                let errorMsg = error.message || 'Failed to get response';
                
                // Add troubleshooting tips based on the error
                if (errorMsg.includes('connect')) {
                    errorMsg += '\n\nTroubleshooting tips:\n1. Make sure the backend server is running (npm run dev)\n2. Check if n8n is running (http://localhost:5678)\n3. Verify your database connection';
                } else if (errorMsg.includes('timed out')) {
                    errorMsg += '\n\nTroubleshooting tips:\n1. The server might be overloaded\n2. Check if OpenAI API is responsive\n3. Try a simpler query';
                }
                
                addErrorMessage(errorMsg);
            } finally {
                // Always remove the loading indicator
                const loadingIndicator = document.getElementById('loadingIndicator');
                if (loadingIndicator) {
                    loadingIndicator.remove();
                }
                
                // Reset loading state
                state.isLoading = false;
                updateSendButtonState();
            }
        }
        
        // Add message to UI
        function addMessageToUI(type, content, extras = {}, messageId = null) {
            log(`Adding ${type} message to UI: ${content.substring(0, 30)}...`);
            
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = type === 'user' ? 'user-message' : 'system-message';
            
            // Add ID if provided (useful for referencing later)
            if (messageId) {
                messageElement.id = messageId;
            }
            
            // Add message content
            const contentElement = document.createElement('div');
            contentElement.textContent = content;
            messageElement.appendChild(contentElement);
            
            // Add SQL query if available
            if (extras.sql) {
                const sqlContainer = document.createElement('div');
                sqlContainer.className = 'sql-container';
                
                const sqlTitle = document.createElement('div');
                sqlTitle.className = 'sql-title';
                sqlTitle.textContent = 'Generated SQL:';
                sqlContainer.appendChild(sqlTitle);
                
                const sqlContent = document.createElement('code');
                sqlContent.textContent = extras.sql;
                sqlContainer.appendChild(sqlContent);
                
                messageElement.appendChild(sqlContainer);
            }
            
            // Add data table if available
            if (extras.data && extras.data.length > 0) {
                const dataContainer = document.createElement('div');
                dataContainer.className = 'data-container';
                
                // Add download buttons
                const downloadContainer = document.createElement('div');
                downloadContainer.className = 'download-container';
                
                const downloadButton = document.createElement('button');
                downloadButton.className = 'download-button';
                downloadButton.textContent = 'Download JSON';
                downloadButton.title = 'Download query results as JSON';
                downloadButton.onclick = function() {
                    const dataToExport = {
                        timestamp: new Date().toISOString(),
                        query: extras.sql || '',
                        results: extras.data,
                        userQuery: content,
                        naturalLanguageResponse: extras.message || ''
                    };
                    
                    // Create blob and download
                    const blob = new Blob([JSON.stringify(dataToExport, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `query_${new Date().toISOString().replace(/[:.]/g, '-')}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                };
                
                downloadContainer.appendChild(downloadButton);
                
                // If results have a filename, add server download option
                if (extras.filename) {
                    const serverDownloadButton = document.createElement('button');
                    serverDownloadButton.className = 'download-button';
                    serverDownloadButton.textContent = 'Download from Server';
                    serverDownloadButton.title = 'Download the stored results file from the server';
                    serverDownloadButton.onclick = function() {
                        window.open(`/api/chat/results/${extras.filename}`, '_blank');
                    };
                    downloadContainer.appendChild(serverDownloadButton);
                }
                
                dataContainer.appendChild(downloadContainer);
                
                const table = document.createElement('table');
                
                // Create table header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                
                const columns = Object.keys(extras.data[0]);
                columns.forEach(column => {
                    const th = document.createElement('th');
                    th.textContent = column;
                    headerRow.appendChild(th);
                });
                
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                
                extras.data.forEach(row => {
                    const tr = document.createElement('tr');
                    
                    columns.forEach(column => {
                        const td = document.createElement('td');
                        td.textContent = row[column] != null ? row[column] : '';
                        tr.appendChild(td);
                    });
                    
                    tbody.appendChild(tr);
                });
                
                table.appendChild(tbody);
                dataContainer.appendChild(table);
                messageElement.appendChild(dataContainer);
            }
            
            // Add timestamp
            const timeElement = document.createElement('div');
            timeElement.className = 'message-time';
            timeElement.textContent = new Date().toLocaleTimeString();
            messageElement.appendChild(timeElement);
            
            // Add to container
            messagesDiv.appendChild(messageElement);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Save message to state
            state.messages.push({
                id: messageId || `msg-${Date.now()}`,
                type,
                content,
                extras,
                timestamp: new Date()
            });
            
            return messageElement; // Return the element for potential reference
        }
        
        // Add error message to UI
        function addErrorMessage(errorText) {
            log(`Adding error message: ${errorText}`);
            const errorElement = document.createElement('div');
            errorElement.className = 'error-message';
            
            // Look for newlines to format structured error messages
            if (errorText.includes('\n')) {
                const parts = errorText.split('\n\n');
                
                // Main error
                const mainError = document.createElement('div');
                mainError.style.fontWeight = 'bold';
                mainError.textContent = `Error: ${parts[0]}`;
                errorElement.appendChild(mainError);
                
                // Additional information if available
                if (parts.length > 1) {
                    parts.slice(1).forEach(part => {
                        const lines = part.split('\n');
                        const section = document.createElement('div');
                        section.style.marginTop = '8px';
                        
                        // Create a title if there is one
                        if (lines[0].endsWith(':')) {
                            const title = document.createElement('div');
                            title.style.fontWeight = 'bold';
                            title.textContent = lines[0];
                            section.appendChild(title);
                            
                            // Add the remaining lines
                            if (lines.length > 1) {
                                const list = document.createElement('ul');
                                list.style.marginTop = '4px';
                                list.style.marginBottom = '0';
                                lines.slice(1).forEach(line => {
                                    // Check if line starts with a number (like "1.")
                                    if (/^\d+\./.test(line)) {
                                        const item = document.createElement('li');
                                        item.textContent = line.replace(/^\d+\.\s*/, '');
                                        list.appendChild(item);
                                    } else {
                                        const item = document.createElement('div');
                                        item.textContent = line;
                                        section.appendChild(item);
                                    }
                                });
                                if (list.children.length > 0) {
                                    section.appendChild(list);
                                }
                            }
                        } else {
                            // Just regular text
                            const content = document.createElement('div');
                            content.textContent = part;
                            section.appendChild(content);
                        }
                        
                        errorElement.appendChild(section);
                    });
                }
            } else {
                // Simple error message
                errorElement.textContent = `Error: ${errorText}`;
            }
            
            // Add a retry button for convenience
            const buttonsContainer = document.createElement('div');
            buttonsContainer.style.marginTop = '10px';
            buttonsContainer.style.display = 'flex';
            buttonsContainer.style.gap = '10px';
            
            // Check server button
            const checkServerBtn = document.createElement('button');
            checkServerBtn.textContent = 'Check Server';
            checkServerBtn.style.padding = '5px 10px';
            checkServerBtn.style.backgroundColor = '#2196f3';
            checkServerBtn.style.color = 'white';
            checkServerBtn.style.border = 'none';
            checkServerBtn.style.borderRadius = '4px';
            checkServerBtn.style.cursor = 'pointer';
            checkServerBtn.onclick = async function() {
                const isConnected = await checkServerConnectivity();
                
                // Show temporary alert
                const alertElement = document.createElement('div');
                alertElement.style.padding = '8px';
                alertElement.style.marginTop = '8px';
                alertElement.style.backgroundColor = isConnected ? '#e8f5e9' : '#ffebee';
                alertElement.style.borderRadius = '4px';
                alertElement.textContent = isConnected 
                    ? 'Server is running and accessible! Try sending your message again.' 
                    : 'Server is not responding. Make sure the backend is running (npm run dev)';
                
                errorElement.appendChild(alertElement);
                
                // Remove after 5 seconds
                setTimeout(() => {
                    try {
                        errorElement.removeChild(alertElement);
                    } catch (e) {}
                }, 5000);
            };
            
            buttonsContainer.appendChild(checkServerBtn);
            
            errorElement.appendChild(buttonsContainer);
            
            messagesDiv.appendChild(errorElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            return errorElement;
        }
        
        // Update send button state based on loading and input
        function updateSendButtonState() {
            const disabled = state.isLoading || !inputBox.value.trim();
            log(`Updating send button state - disabled: ${disabled}`);
            sendButton.disabled = disabled;
        }
        
        // Initialize the application
        async function initializeApp() {
            log('Initializing application');
            
            // Check server connectivity
            state.serverConnected = await checkServerConnectivity();
            
            // Set up event listeners for the example queries
            document.querySelectorAll('#example-list li').forEach(item => {
                const query = item.getAttribute('data-query') || item.textContent;
                item.addEventListener('click', function() {
                    useExample(query);
                });
            });
            
            // Form submission handler
            chatForm.addEventListener('submit', sendMessage);
            
            // Input event for button state
            inputBox.addEventListener('input', updateSendButtonState);
            
            // Initial button state
            updateSendButtonState();
            
            log('Application initialized');
        }
        
        // Start the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
        
        // System diagnostics functions
        const diagnosticsPanel = document.getElementById('diagnostics-panel');
        const diagnosticsContent = document.getElementById('diagnostics-content');
        const showDiagnosticsBtn = document.getElementById('show-diagnostics-btn');
        const closeDiagnosticsBtn = document.getElementById('close-diagnostics-btn');
        const runDiagnosticsBtn = document.getElementById('run-diagnostics-btn');
        
        // Show/hide diagnostics panel
        showDiagnosticsBtn.addEventListener('click', () => {
            diagnosticsPanel.style.display = 'block';
            runSystemDiagnostics();
        });
        
        closeDiagnosticsBtn.addEventListener('click', () => {
            diagnosticsPanel.style.display = 'none';
        });
        
        runDiagnosticsBtn.addEventListener('click', runSystemDiagnostics);
        
        // Run all system diagnostics
        async function runSystemDiagnostics() {
            diagnosticsContent.innerHTML = '<p>Running system checks...</p>';
            
            const results = [];
            
            // Check 1: Backend server
            try {
                const serverResponse = await fetch('/health', { 
                    method: 'GET',
                    timeout: 5000
                });
                
                if (serverResponse.ok) {
                    const data = await serverResponse.json();
                    results.push({
                        name: 'Backend Server',
                        status: 'OK',
                        details: `Running in ${data.environment} mode`
                    });
                } else {
                    results.push({
                        name: 'Backend Server',
                        status: 'Error',
                        details: `Server returned status ${serverResponse.status}`
                    });
                }
            } catch (error) {
                results.push({
                    name: 'Backend Server',
                    status: 'Error',
                    details: `Cannot connect to server: ${error.message}`
                });
            }
            
            // Check 2: Check database schema endpoint
            try {
                const schemaResponse = await fetch('/api/chat/schema', { 
                    method: 'GET',
                    timeout: 5000
                });
                
                if (schemaResponse.ok) {
                    const data = await schemaResponse.json();
                    const tableCount = data.schema?.tables?.length || 0;
                    results.push({
                        name: 'Database Connection',
                        status: 'OK',
                        details: `Connected to database with ${tableCount} tables`
                    });
                } else {
                    results.push({
                        name: 'Database Connection',
                        status: 'Error',
                        details: `Server returned status ${schemaResponse.status} when checking database schema`
                    });
                }
            } catch (error) {
                results.push({
                    name: 'Database Connection',
                    status: 'Error',
                    details: `Cannot retrieve database schema: ${error.message}`
                });
            }
            
            // Check 3: Try a simple query execution
            try {
                const queryResponse = await fetch('/api/chat/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: 'SELECT 1 as test'
                    }),
                    timeout: 8000
                });
                
                if (queryResponse.ok) {
                    results.push({
                        name: 'Query Execution (n8n)',
                        status: 'OK',
                        details: 'Successfully executed a simple test query'
                    });
                } else {
                    const errorData = await queryResponse.json();
                    results.push({
                        name: 'Query Execution (n8n)',
                        status: 'Error',
                        details: `Failed to execute query: ${errorData.message || queryResponse.status}`
                    });
                }
            } catch (error) {
                results.push({
                    name: 'Query Execution (n8n)',
                    status: 'Error',
                    details: `Cannot execute test query: ${error.message}`
                });
            }
            
            // Generate results HTML
            let resultsHtml = '<div style="margin-bottom: 15px;">';
            let allOk = true;
            
            results.forEach(result => {
                const isOk = result.status === 'OK';
                if (!isOk) allOk = false;
                
                resultsHtml += `
                <div style="margin-bottom: 10px; padding: 8px; border-radius: 4px; background: ${isOk ? '#e8f5e9' : '#ffebee'}; border-left: 4px solid ${isOk ? '#4caf50' : '#f44336'};">
                    <div style="display: flex; justify-content: space-between;">
                        <strong>${result.name}</strong>
                        <span style="color: ${isOk ? '#2e7d32' : '#c62828'};">${result.status}</span>
                    </div>
                    <div style="margin-top: 5px; font-size: 0.9em;">${result.details}</div>
                </div>`;
            });
            
            resultsHtml += '</div>';
            
            // Add troubleshooting guidance
            if (!allOk) {
                resultsHtml += `
                <div style="border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                    <h4 style="margin-top: 0;">Troubleshooting Steps</h4>
                    <ol style="padding-left: 20px; margin-top: 5px;">
                        <li>Make sure the backend server is running: <code>npm run dev</code></li>
                        <li>Check if n8n is running: <code>n8n start</code> and open <a href="http://localhost:5678" target="_blank">http://localhost:5678</a></li>
                        <li>Verify the database credentials in your <code>.env</code> file</li>
                        <li>Try running <code>npm run db:refresh</code> to test database connectivity</li>
                        <li>Make sure your OpenAI API key is valid</li>
                    </ol>
                </div>`;
            } else {
                resultsHtml += `
                <div style="border-top: 1px solid #e0e0e0; padding-top: 10px; margin-top: 10px;">
                    <h4 style="margin-top: 0; color: #2e7d32;">All Systems Operational âœ“</h4>
                    <p>The system components appear to be working correctly. If you're still experiencing issues, check your browser console for errors.</p>
                </div>`;
            }
            
            diagnosticsContent.innerHTML = resultsHtml;
        }
    </script>
</body>
</html>